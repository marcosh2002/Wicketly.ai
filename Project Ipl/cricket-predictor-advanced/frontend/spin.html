<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spin & Win Tokens - IPL Predictor</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      margin: 0;
    }
    
    .spin-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .balance-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .balance-label {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .balance-value {
      font-size: 64px;
      font-weight: 900;
      color: #1e2a78;
      margin-bottom: 10px;
    }
    
    .spin-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }
    
    .spin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .spin-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e2a78;
    }
    
    .spins-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .spin-content {
      display: flex;
      gap: 40px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .wheel-container {
      position: relative;
      width: 280px;
      height: 280px;
    }
    
    .spin-wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        #FF6B6B 0deg 90deg,
        #4ECDC4 90deg 180deg,
        #45B7D1 180deg 270deg,
        #FFA07A 270deg 360deg
      );
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.3), inset 0 0 30px rgba(255,255,255,0.2);
      border: 8px solid white;
      font-size: 24px;
      font-weight: 800;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
      transition: transform 0.1s linear;
    }
    
    .spin-wheel.spinning {
      animation: spin 0.5s ease-out;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .wheel-pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 25px solid #1e2a78;
      z-index: 10;
    }
    
    .spin-info {
      flex: 1;
      min-width: 300px;
    }
    
    .spin-description {
      font-size: 16px;
      color: #555;
      line-height: 1.8;
      margin-bottom: 20px;
    }
    
    .rewards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 12px;
    }
    
    .reward-item {
      padding: 12px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      color: #1e2a78;
      border: 2px solid #f0f0f0;
    }
    
    .spin-button {
      padding: 16px 40px;
      font-size: 18px;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      margin-bottom: 16px;
    }
    
    .spin-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }
    
    .spin-button:active:not(:disabled) {
      transform: translateY(-1px);
    }
    
    .spin-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .last-win {
      font-size: 14px;
      color: #666;
      padding: 12px;
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      border-radius: 4px;
    }
    
    .last-win strong {
      color: #1e2a78;
      font-size: 18px;
    }
    
    .login-section {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .login-section h2 {
      font-size: 36px;
      color: #1e2a78;
      margin-bottom: 20px;
    }
    
    .login-section p {
      font-size: 16px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .login-input {
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #ddd;
      font-size: 16px;
      width: 280px;
      margin-bottom: 16px;
      transition: border-color 0.3s;
    }
    
    .login-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-button {
      padding: 12px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .tips-card {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      border-radius: 20px;
      padding: 30px;
      color: #333;
    }
    
    .tips-card h3 {
      margin-top: 0;
      font-size: 22px;
    }
    
    .tips-card ul {
      line-height: 1.9;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="spin-container">
    
    <!-- Login Section (shown when not logged in) -->
    <div id="loginSection" class="login-section" style="display:none;">
      <h2>üé° Spin & Win Tokens</h2>
      <p>You need to be logged in to use the spin feature</p>
      <input id="usernameInput" type="text" class="login-input" placeholder="Enter your username" autocomplete="username">
      <br>
      <button class="login-button" onclick="login()">Login</button>
    </div>
    
    <!-- Main Spin Section (shown when logged in) -->
    <div id="spinSection" style="display:none;">
      <!-- Balance Card -->
      <div class="balance-card">
        <div class="balance-label">Your Points Balance</div>
        <div class="balance-value" id="pointsBalance">...</div>
        <div class="balance-label">‚ö° Points Available</div>
      </div>
      
      <!-- Spin Card -->
      <div class="spin-card">
        <div class="spin-header">
          <div class="spin-title">üé° Spin & Win Tokens</div>
          <div class="spins-badge">Spins left: <span id="spinsLeft">2</span>/2</div>
        </div>
        
        <div class="spin-content">
          <!-- Spinning Wheel -->
          <div class="wheel-container">
            <div class="wheel-pointer"></div>
            <div class="spin-wheel" id="spinWheel">
              <span id="wheelText">5</span>
            </div>
          </div>
          
          <!-- Spin Info -->
          <div class="spin-info">
            <div class="spin-description">
              You can spin up to <strong>2 times per day</strong>. Each spin randomly awards tokens to your balance!
            </div>
            
            <div style="background: #f9f9f9; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
              <strong style="color: #1e2a78;">Possible Rewards:</strong>
              <div class="rewards-grid">
                <div class="reward-item">5 üéÅ</div>
                <div class="reward-item">15 üéÅ</div>
                <div class="reward-item">50 üéÅ</div>
                <div class="reward-item">100 üéÅ</div>
              </div>
            </div>
            
            <button class="spin-button" id="spinButton" onclick="performSpin()">
              üé° SPIN NOW
            </button>
            
            <div class="last-win" id="lastWin" style="display:none;">
              Last win: <strong id="lastWinAmount">-</strong> tokens
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tips Card -->
      <div class="tips-card">
        <h3>üí° How to Earn More Points</h3>
        <ul>
          <li><strong>Daily Spins:</strong> Come back every day for 2 free spins</li>
          <li><strong>Referrals:</strong> Invite friends and earn 50 bonus points each</li>
          <li><strong>Predictions:</strong> Make accurate predictions to climb the leaderboard</li>
        </ul>
      </div>
    </div>
    
  </div>
  
  <script>
    let currentUser = localStorage.getItem('ipl_username');
    let isSpinning = false;
    
    function login() {
      const username = document.getElementById('usernameInput').value.trim();
      if (!username) {
        alert('Please enter a username');
        return;
      }
      currentUser = username;
      localStorage.setItem('ipl_username', username);
      initPage();
    }
    
    function logout() {
      currentUser = null;
      localStorage.removeItem('ipl_username');
      initPage();
    }
    
    async function initPage() {
      if (!currentUser) {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('spinSection').style.display = 'none';
        return;
      }
      
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('spinSection').style.display = 'block';
      
      // Fetch and display balance
      try {
        const balanceRes = await fetch(`http://127.0.0.1:8000/users/${encodeURIComponent(currentUser)}/balance`);
        const balanceData = await balanceRes.json();
        if (balanceData.ok) {
          document.getElementById('pointsBalance').textContent = balanceData.tokens;
        }
      } catch (err) {
        console.error('Error fetching balance:', err);
      }
      
      // Fetch spin status
      try {
        const statusRes = await fetch(`http://127.0.0.1:8000/users/${encodeURIComponent(currentUser)}/spin_status`);
        const statusData = await statusRes.json();
        if (statusData.ok) {
          document.getElementById('spinsLeft').textContent = statusData.spins_left;
          const btn = document.getElementById('spinButton');
          if (statusData.spins_left <= 0) {
            btn.disabled = true;
            btn.textContent = '‚ùå No Spins Left Today';
          }
          if (statusData.last_reward) {
            document.getElementById('lastWinAmount').textContent = statusData.last_reward;
            document.getElementById('lastWin').style.display = 'block';
          }
        }
      } catch (err) {
        console.error('Error fetching spin status:', err);
      }
    }
    
    async function performSpin() {
      if (!currentUser || isSpinning) return;
      
      const btn = document.getElementById('spinButton');
      const wheel = document.getElementById('spinWheel');
      const wheelText = document.getElementById('wheelText');
      
      if (btn.disabled) return;
      
      isSpinning = true;
      btn.disabled = true;
      btn.textContent = '‚è≥ Spinning...';
      
      const rewards = [5, 15, 50, 100];
      let rotation = 0;
      let currentRewardIndex = 0;
      
      // Fast spinning animation (3 rotations with reward cycling)
      const spinInterval = setInterval(() => {
        rotation += 90;
        wheel.style.transform = `rotate(${rotation}deg)`;
        wheelText.textContent = rewards[currentRewardIndex % rewards.length];
        currentRewardIndex++;
      }, 50);
      
      try {
        const response = await fetch(`http://127.0.0.1:8000/users/${encodeURIComponent(currentUser)}/spin`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (!data.ok) {
          clearInterval(spinInterval);
          wheel.style.transform = 'rotate(0deg)';
          wheelText.textContent = 'Err';
          alert(data.error || 'Spin failed');
          btn.disabled = false;
          btn.textContent = 'üé° SPIN NOW';
          isSpinning = false;
          return;
        }
        
        const finalReward = data.reward;
        
        // Stop after ~2 seconds of spinning
        setTimeout(() => {
          clearInterval(spinInterval);
          
          // Set final rotation to land on the won reward
          const rewardAngle = rewards.indexOf(finalReward) * 90;
          wheel.style.transform = `rotate(${1080 + rewardAngle}deg)`;
          wheelText.textContent = finalReward;
          
          // Update UI
          document.getElementById('pointsBalance').textContent = data.tokens_remaining;
          document.getElementById('spinsLeft').textContent = data.spins_left;
          document.getElementById('lastWinAmount').textContent = finalReward;
          document.getElementById('lastWin').style.display = 'block';
          
          // Show celebration alert
          setTimeout(() => {
            alert(`üéâ Congratulations!\n\nYou won ${finalReward} tokens! üéÅ\n\nYour balance: ${data.tokens_remaining}`);
            
            // Reset button
            if (data.spins_left > 0) {
              btn.disabled = false;
              btn.textContent = 'üé° SPIN NOW';
            } else {
              btn.disabled = true;
              btn.textContent = '‚ùå No Spins Left Today';
            }
            
            isSpinning = false;
          }, 500);
          
        }, 2000);
        
      } catch (err) {
        clearInterval(spinInterval);
        console.error('Spin error:', err);
        alert('Could not perform spin. Please try again.');
        wheel.style.transform = 'rotate(0deg)';
        wheelText.textContent = 'Err';
        btn.disabled = false;
        btn.textContent = 'üé° SPIN NOW';
        isSpinning = false;
      }
    }
    
    // Initialize on page load
    initPage();
  </script>
</body>
</html>
